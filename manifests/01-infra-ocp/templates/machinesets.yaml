{{- $region := .Values.region -}}
{{- $zones := .Values.zones -}}
{{- $cluster := .Values.clusterApiCluster | default "test" -}}

{{- range $i, $machineset := .Values.machinesets }}
{{- range $j, $zone := $zones }}
{{- $name := printf "%s-%s-%s" $machineset.name $region $zone }}
---
apiVersion: machine.openshift.io/v1beta1
kind: MachineSet
metadata:
  name: {{ $name }}
  namespace: {{ $.Values.namespace }}
  labels:
    machine.openshift.io/cluster-api-cluster: {{ $cluster }}
  annotations:
  {{- with $machineset.annotations | default (dict) }}
  {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  replicas: {{ $machineset.replicas }}
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: {{ $cluster }}
      machine.openshift.io/cluster-api-machineset: {{ $name }}
  template:
    metadata:
      labels:
        machine.openshift.io/cluster-api-cluster: {{ $cluster }}
        machine.openshift.io/cluster-api-machine-role: worker
        machine.openshift.io/cluster-api-machine-type: worker
        machine.openshift.io/cluster-api-machineset: {{ $name }}
    spec:
      metadata:
        labels:
        {{- with $machineset.nodeLabels | default (dict) }}
        {{- toYaml . | nindent 10 }}
        {{- end }}
{{- if and (hasKey $machineset "taints") (gt (len $machineset.taints) 0) }}
      taints:
{{- $machineset.taints | toYaml | nindent 8 }}
{{- end }}
      providerSpec:
        value:
{{- if $.Values.aws }}
          apiVersion: machine.openshift.io/v1beta1
          kind: AWSMachineProviderConfig
          userDataSecret:
            name: {{ $.Values.aws.userDataSecretName }}
          placement:
            availabilityZone: {{ printf "%s%s" $region $zone }}
            region: {{ $region }}
          credentialsSecret:
            name: {{ $.Values.aws.credentialsSecretName }}
          instanceType: {{ $machineset.instanceType }}
          metadata:
            creationTimestamp: null
          blockDevices:
            - ebs:
                encrypted: true
                kmsKey:
                  arn: {{ $.Values.aws.kmsKeyArn | default "" }}
                volumeSize: {{ $machineset.volumeSize }}
                volumeType: gp3
          securityGroups:
            - filters:
                - name: 'tag:Name'
                  values:
                    - {{ $cluster }}-node
            - filters:
                - name: 'tag:Name'
                  values:
                    - {{ $cluster }}-lb
          iamInstanceProfile:
            id: {{ $cluster }}-worker-profile
          ami:
            id: {{ index $.Values.amis $machineset.architecture | default "" }}
          metadataServiceOptions: {}
          tags:
            - name: kubernetes.io/cluster/{{ $cluster }}
              value: owned
          deviceIndex: 0
          ami:
            id: {{ index $.Values.amis $machineset.architecture | default "" }}
          subnet:
            filters:
              - name: 'tag:Name'
                values:
                  - {{ $cluster }}-subnet-private-{{ $region }}{{ $zone }}
          iamInstanceProfile:
            id: {{ $cluster }}-worker-profile
{{- else if $.Values.ibmCloud }}
          apiVersion: ibmcloudproviderconfig.openshift.io/v1beta1
          kind: IBMCloudMachineProviderSpec
          credentialsSecret:
            name: ibmcloud-credentials
          image: {{ $cluster }}-rhcos
          metadata:
            creationTimestamp: null
          primaryNetworkInterface:
            securityGroups:
            - {{ $cluster }}-sg-cluster-wide
            - {{ $cluster }}-sg-openshift-net
            subnet: {{ $cluster }}-subnet-compute-{{ $region }}-{{ $zone }}
          profile: {{ $machineset.instanceType }}
          region: {{ $region }}
          resourceGroup: {{ $.Values.ibmCloud.resourceGroup | default "Default" }}
          userDataSecret:
            name: worker-user-data
          vpc: {{ $cluster }}-vpc
          zone: {{ $region }}-{{ $zone }}
{{- else }}
          # No provider selected â€” fail
{{- end -}}
{{- end -}}
{{- end -}}
